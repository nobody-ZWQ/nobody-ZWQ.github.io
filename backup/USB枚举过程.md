## **USB 枚举的相对粗略的过程**

### 1. **物理连接**
- USB 设备插入主机（如 PC、嵌入式板卡）的 USB 端口。
- 主机检测到物理电气信号变化（如 VBUS 电压上升、信号线拉高/拉低）。

### 2. **总线复位（Bus Reset）**
- 主机向设备发送复位信号（通过信号线拉低 10ms 以上）。
- 设备进入默认状态，准备响应主机请求。

### 3. **设备检测与速度识别**
- 主机检测设备的连接速度（低速、全速、高速、超高速）。
- 主机通过差分信号（D+/D-）判断设备类型，并选择合适的通信速率。

### 4. **获取设备描述符（Device Descriptor）**
- 主机向设备发送请求（Get Descriptor），获取设备描述符（包括厂商 ID、产品 ID、设备类型等基础信息）。
- 设备响应主机，返回设备描述符数据包。

### 5. **分配地址（Set Address）**
- 主机分配一个唯一的 USB 地址给设备（默认地址为 0，分配后为 1~127）。
- 设备接收并设置新地址用于后续通信。

### 6. **获取配置描述符（Configuration Descriptor）**
- 主机再次请求设备，获取配置描述符（包括设备支持的配置、接口、端点等详细信息）。
- 设备返回配置描述符数据包。

### 7. **获取接口和端点描述符**
- 主机读取设备的接口、端点描述符（Interface Descriptor、Endpoint Descriptor），了解设备支持的功能和数据传输方式。

### 8. **设置配置（Set Configuration）**
- 主机选择一个配置并发送 Set Configuration 请求，激活设备的相关功能。
- 设备根据主机请求，切换到指定配置，准备正式工作。

### 9. **驱动加载与应用初始化**
- 主机操作系统根据设备描述符信息，加载相应的驱动程序（如 USB 摄像头驱动、存储设备驱动等）。
- 驱动完成初始化后，设备可以被上层应用访问和使用。

## **USB控制器寄存器变化**

**USB枚举过程中寄存器变化**
- ​**寄存器变化**​：
	- ​**PORTSC（端口状态控制寄存器）​**​：
		- `CCS`（Current Connect Status）位由0→1，触发控制器中断
		- `PED`（Port Enable/Disable）位由0→1，表示端口已使能
	- ​**PHY寄存器**​：
		- 检测到D+/D-线电压变化（如高速设备插入时D+拉高）
**设备复位​**
- ​**控制器操作**​：
	- 向`PORTSC`寄存器写入`PR`（Port Reset）位=1，启动复位
	- 复位期间
		- portsc端口状态控制寄存器的`LS`（Line Status）位反映当前速度（00=全速，01=低速，10=高速）
		- 复位完成后 portsc（端口状态控制寄存器）自动清零
**获取设备描述符​**
- ​**寄存器交互**​：
    - ​**控制传输阶段**​：
	    - **setup事务中**：
        1. ​**SETUP包**​：
            - 主机发送Setup Token包（PID=0x2D）
            - 控制器通过`ENDPTSETUPSTAT`端点setup状态寄存器确认Setup包接收
        2. ​**DATA包**​：
            - 读取`EP0 FIFO`寄存器，获取设备描述符（长度默认18字节）
            - 写入`EP0 CSR`（控制状态寄存器）的`RXPKTRDY`（receive packet ready）位=1，通知主机数据就绪
        3. ​**握手包**​：
            - 清除`EP0 CSR`（控制状态寄存器）的`RXPKTRDY`位
            - 向`EP0 FIFO`写入0字节数据，设置`TXPKTRDY`（transfer packet ready）位=1完成握手
**地址分配​**
- ​**寄存器操作**​：
    - 主机下发Set Address命令后：
        - 将新地址写入`DEVICEADDR`寄存器
        - 设置`DEVICEADDR`的`LSEN`（Low Speed Enable）速度位适配设备速度
    - 地址生效需等待下一个IN/OUT事务
**配置设备​**
- ​**寄存器配置**​：
    - 解析Set Configuration命令后：
        - 写入`CONFIGURATION`寄存器选择配置值
        - 使能对应端点：
            - 设置`ENDPTCTRL[EndPoint]`寄存器的`EP_EN`位=1
            - 配置传输类型（如Bulk/Interrupt）：
                - `EP_TYPE`字段：00=控制，01=等时，10=Bulk，11=Interrupt
                - `EP_DIR`字段：0=OUT，1=IN

**USB数据传输过程（以Bulk传输为例）​**
​**OUT传输（主机→设备）​**​
- ​**寄存器流程**​：
    1. ​**数据接收**​：
        - 主机发送OUT Token包后，数据通过D+/-线传输
        - 数据自动填充到从机的`EPn FIFO`寄存器
    2. ​**通知应用层**​：
        - 设置`ENDPTSTAT`的`RX`位=1，触发中断
        - 应用层读取`EPn FIFO`数据并清除`RX`位
    3. ​**ACK响应**​：
        - 从机自动发送ACK握手包（若数据无误）
        - 若数据错误：
            - 设置`ENDPTSTAT`的`ERR`位=1
            - 从机发送NAK/NYET包时要求主机进行重传
**IN传输（设备→主机）​**​
- ​**寄存器流程**​：
    1. ​**数据准备**​：
        - 将数据写入`EPn FIFO`寄存器（n为端点号）
        - 设置`ENDPTSTAT`寄存器的`TX`位=1，标记端点有数据待发送
    2. ​**传输触发**​：
        - 主机发送IN Token包后：
            - 控制器自动读取`EPn FIFO`数据并通过D+/-线发送
            - 传输完成后`ENDPTSTAT`的`TX`位自动清零
    3. ​**握手信号**​：
        - 根据CRC校验结果更新`ENDPTSTAT`的`ERR`位（若有错误）
